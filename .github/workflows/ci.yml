name: CI

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎
        uses: actions/checkout@v3
      - name: Install NPM dependencies 📦
        uses: pnpm/action-setup@v2
        with:
          version: latest
          run_install: true
      - name: Cache pnpm modules 🗂️
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-pkg-${{ hashFiles('**/pnpm-lock.yaml') }}
      - name: Check types 🧩
        uses: icrawl/action-tsc@v1
        with:
          project: tsconfig.build.json
      - name: Choose reporter for ReviewDog 🚦
        uses: haya14busa/action-cond@v1
        id: reporter
        with:
          cond: ${{ github.event_name == 'pull_request' }}
          if_true: 'github-pr-review'
          if_false: 'github-check'
      - name: Run ESlint 🧹
        uses: reviewdog/action-eslint@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          eslint_flags: --ext .js,.ts .
          reporter: ${{ steps.reporter.outputs.value }}
      - name: Run ShellCheck 🐚
        uses: reviewdog/action-shellcheck@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: ${{ steps.reporter.outputs.value }}
          shellcheck_flags: -e SC1091
          path: .husky
          pattern: '*'
          exclude: '*/.gitignore'

  test:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    steps:
      - name: Checkout 🛎
        uses: actions/checkout@v3
      - name: Install NPM dependencies 📦
        uses: pnpm/action-setup@v2
        with:
          version: latest
          run_install: true
      - name: Cache pnpm modules 🗂️
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-pkg-${{ hashFiles('**/pnpm-lock.yaml') }}
      - name: Run tests 🧪
        run: pnpm test:cov -- --ci --json --testLocationInResults --outputFile=result.json
        env:
          SECRET: qui-eu-ad-excepteur-occaecat-id-ipsum-ex-minim
      - name: Report test results 📝
        uses: tanmen/jest-reporter@v1
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Monitor coverage 📫
        uses: slavcodev/coverage-monitor-action@1.6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          coverage_format: clover
          coverage_path: coverage/clover.xml
          check: github.event_name == 'pull_request'
          threshold_alert: 50
          threshold_warning: 80
      - name: Upload code coverage ⬆️
        uses: actions/upload-artifact@v3
        with:
          name: unit-coverage
          path: coverage

  e2e:
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: armband
          POSTGRES_PASSWORD: 9HNtQV78T4MmBibJ
          POSTGRES_DB: sharper
        ports:
          - 5432:5432
        # needed because the postgres container does not provide a healthcheck
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - name: Checkout 🛎
        uses: actions/checkout@v3
      - name: Install NPM dependencies 📦
        uses: pnpm/action-setup@v2
        with:
          version: latest
          run_install: true
      - name: Cache pnpm modules 🗂️
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-pkg-${{ hashFiles('**/pnpm-lock.yaml') }}
      - name: Build 🛠️
        run: pnpm build
      - name: Run migrations 🧰
        run: |
          pnpm typeorm migration:run
          pnpm fixtures
        env:
          DATABASE_URL: postgres://armband:9HNtQV78T4MmBibJ@localhost:${{ job.services.postgres.ports[5432] }}/sharper
      - name: Run the server 🚀
        run: pnpm start:prod &
        env:
          PORT: 3000
          SECRET: quis-voluptate-quis-sit-incididunt-ullamco-reprehenderit-ut-magna-laborum-irure-eu-adipisicing
          DATABASE_URL: postgres://armband:9HNtQV78T4MmBibJ@localhost:${{ job.services.postgres.ports[5432] }}/sharper
          NODE_ENV: production
      - name: Run tests 🧪
        run: pnpm test:e2e -- --ci --json --testLocationInResults --outputFile=result.json
      - name: Report test results 📝
        uses: tanmen/jest-reporter@v1
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          action-name: e2e report
